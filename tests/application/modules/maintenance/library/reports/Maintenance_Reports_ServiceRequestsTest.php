<?php
/**
 * Test class for Maintenance_Library_Reports_ServiceRequestsTest
 * Generated by PHPUnit on 2010-10-29 at 23:31:16.
 */
// phpunit --no-configuration --bootstrap application/bootstrap.php application/modules/maintenance/library/reports/Maintenance_Reports_ServiceRequestsTest.php
class Maintenance_Library_Reports_ServiceRequestsTest extends ControllerTestCase {

	/* (non-PHPdoc)
	 * @see Framework/PHPUnit_Framework_TestCase::setUp()
	 */
	public function setUp()
	{
		parent::setUp();
		$this->dataSetStackBuffer = array('users'=>1,'apartmentsUnitsAndModels'=>1,'serviceRequestsReport'=>1);
		$this->login('jvazquez','Test1234');
		$this->loadDataSets();
	}

	/* (non-PHPdoc)
	 * @see Framework/PHPUnit_Framework_TestCase::tearDown()
	 */
	public function tearDown()
	{
		$this->unLoadDataSets();
		parent::tearDown();
	}

	public function testInitDb()
	{
		$object = new Maintenance_Library_Reports_ServiceRequests;
		$object->setGatewayLink(Maintenance_Library_Reports_ServiceRequests::DB);
		$db = $object->getGatewayLink();
		$this->assertType('Zend_Db_Adapter_Pdo_Mysql', $db);
	}

	public function testConfigureCache()
	{
		$object = new Maintenance_Library_Reports_ServiceRequests(array('cacheIdentifier'=>'serviceRequests'));
		$object->setCacheFrontEnd('Core');
		//			$object->setCacheBackEnd('Apc');
		$object->setCacheBackEnd('File');
		$object->configureCacheFrontEnd();
		$object->configureCacheBackEnd();
		$object->initCacheManager();
		$this->assertType('Zend_Cache_Manager',$object->getCacheManager());
	}

	public function testRunReportNoCache()
	{
		$object = new Maintenance_Library_Reports_ServiceRequests(array('cacheIdentifier'=>'serviceRequests'));
		$result = $object->runReport(false);
			//	print $object->getQuery()->__toString(); die;
		$this->assertTrue(count($result)>0,'The query failed to obtain results');
		$this->assertEquals("SELECT COUNT(*) AS `numberOfRequests`, `U`.`number` AS `unitNumber`, `UM`.`name` AS `unitModel` FROM `maintenanceRequest` AS `MR`
		                                    INNER JOIN `unit` AS `U` ON MR.unitId = U.id
		                                    INNER JOIN `unitModel` AS `UM` ON U.unitModelId = UM.id
		                                    GROUP BY `unitNumber` ORDER BY `numberOfRequests` DESC",$object->getQuery()->__toString());		
	}
	

	public function testRunReportWithCache()
	{
		$object = new Maintenance_Library_Reports_ServiceRequests(array('cacheIdentifier'=>'serviceRequests'));
		$object->setCacheFrontEnd('Core');
		$object->setCacheBackEnd('File');
		$object->configureCacheFrontEnd();
		$object->configureCacheBackEnd();
		$object->initCacheManager();
		$object->prepareCacheSeed();
		$result = $object->runReport(true);
		$this->assertTrue(count($result)>0,'The query failed to obtain results');
		//	Since we did not seed the object, the tags will match
		$this->assertEquals(Maintenance_Library_Reports_ServiceRequests::DEFAULTSEED,$object->getSeed());
	}


	public function testQueryWithSort()
	{
		$args = array(ZFInterfaces_Sortable::MODE=>ZFInterfaces_Sortable::ASCVIEW,
		ZFInterfaces_Sortable::COLUMN=>'numberOfRequests');
		$object = new Maintenance_Library_Reports_ServiceRequests($args);
		$result = $object->runReport(false);
		$this->assertTrue(preg_match('/ORDER BY `numberOfRequests` ASC/',$object->getQuery()->__toString())==1,$object->getQuery()->__toString());
	}

	public function testHandleQueryParamsMultiple()
	{
		$args = array(ZFInterfaces_Sortable::MODE=>ZFInterfaces_Sortable::ASCVIEW,
		ZFInterfaces_Sortable::COLUMN=>'numberOfRequests','page'=>2,
        			'cacheIdentifier'=>Maintenance_Library_Reports_ServiceRequests::CACHEIDENTIFIER);
		$object = new Maintenance_Library_Reports_ServiceRequests($args);
		$object->prepareCacheSeed();
		$this->assertEquals('serviceRequestsReportpage2numberOfRequestsASC',$object->getSeed());
	}

	public function testHandleQueryParamsPagination()
	{
		$args = array('page'=>2);
		$object = new Maintenance_Library_Reports_ServiceRequests($args);
		$object->prepareCacheSeed();
		$this->assertEquals('serviceRequestsReportpage2',$object->getSeed());
	}

	public function testHandleQueryParamsBadPagination()
	{
		$args = array('fakee'=>2);
		$object = new Maintenance_Library_Reports_ServiceRequests($args);
		$object->prepareCacheSeed();
		$this->assertEquals('serviceRequestsReport',$object->getSeed());
		unset($object);
		$args = array('page'=>"x3");
		$object = new Maintenance_Library_Reports_ServiceRequests($args);
		$object->prepareCacheSeed();
		$this->assertEquals('serviceRequestsReport',$object->getSeed());
	}

/*
	public function testExportReportCreatesFile()
	{
		ob_start();
		$args = array(ZFInterfaces_Sortable::MODE=>ZFInterfaces_Sortable::ASCVIEW,ZFInterfaces_Sortable::COLUMN=>'tenantName','cacheIdentifier'=>'rentRoll');
		$object = new Financial_Library_Reports_RentRoll($args);
		$this->assertEquals($args['cacheIdentifier'],$object->getCacheIdentifier());
		$object->setCacheFrontEnd('Core');
		$object->setCacheBackEnd('File');
		$object->configureCacheFrontEnd();
                $object->configureCacheBackEnd();
                $object->initCacheManager();
                $object->prepareCacheSeed($args);
	        $result = $object->runReport(true);
		$result = $object->exportReport();
		$this->assertTrue($result,'Export report failed to generate a report');
		ob_end_clean();
	}
*/
}
?>